import xsd "bookingReference" as BookingReference, "buy" as Buy, "cancel" as Cancel, "CreditCheckRequest" as CreditInformation, "CreditCheckInvalid" as CreditInvalid, "CreditCheckOk" as CreditValid, "enquiry" as Enquiry, "orderConfirmed" as OrderConfirmed, "orderRejected" as OrderRejected, "quote" as Quote, "quoteList" as QuoteList, "requestForQuote" as RequestForQuote;
protocol ESBBrokerProcess@Broker(role Buyer) {
	Broker introduces CreditAgency;

	makeEnquiry(Enquiry) from Buyer;

	repeat {
		run RequestForQuote@Broker from Broker;
	}

	makeEnquiry(QuoteList) to Buyer;

	choice {
		run CompleteTransaction@Broker(Buyer, CreditAgency) from Buyer;
	} or {
		cancel(Cancel) from Buyer;
	}

	protocol CompleteTransaction@Broker(role Buyer, role CreditAgency) {
		buy(Buy) from Buyer;
		checkCredit(CreditInformation) to CreditAgency;

		choice {
			Broker introduces SupplierTxnProcessor;

			checkCredit(CreditValid) from CreditAgency;
			confirm(OrderConfirmed) to SupplierTxnProcessor;
			confirm(BookingReference) from SupplierTxnProcessor;
			buy(BookingReference) to Buyer;
		} or {
			checkCredit(CreditInvalid) from CreditAgency;
			buy(OrderRejected) to Buyer;
		}
	}

	protocol RequestForQuote@Broker {
		Broker introduces SupplierQuoteEngine;

		getQuote(RequestForQuote) to SupplierQuoteEngine;
		getQuote(Quote) from SupplierQuoteEngine;
	}
}
